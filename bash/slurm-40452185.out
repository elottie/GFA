+ set -euo pipefail
+ chrom=1
+ gwas_info_file=/nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af_thresh=0.05
+ sample_size_tol=0
+ out=C100001554_1_comb_form_output.tsv
+ workdir=workdir_1930361
+ mkdir -p workdir_1930361
+ dos2unix /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
dos2unix: converting file /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv to Unix format...
++ wc -l
++ awk 'NR>1' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ num_traits=3
++ head -1 /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ header=name,raw_data_path,pub_sample_size,effect_is_or,snp,A1,A2,beta_hat,se,pos,p_value,sample_size,chrom,af
+ IFS=,
+ read -ra cols
++ get_col raw_data_path
++ local name=raw_data_path
++ for i in "${!cols[@]}"
++ [[ name == \r\a\w\_\d\a\t\a\_\p\a\t\h ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \r\a\w\_\d\a\t\a\_\p\a\t\h ]]
++ echo 2
++ return
+ col_raw_data=2
++ get_col snp
++ local name=snp
++ for i in "${!cols[@]}"
++ [[ name == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\n\p ]]
++ echo 5
++ return
+ col_snp=5
++ get_col pos
++ local name=pos
++ for i in "${!cols[@]}"
++ [[ name == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ snp == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ se == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ pos == \p\o\s ]]
++ echo 10
++ return
+ col_pos=10
++ get_col chrom
++ local name=chrom
++ for i in "${!cols[@]}"
++ [[ name == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ snp == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ se == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ pos == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ chrom == \c\h\r\o\m ]]
++ echo 13
++ return
+ col_chrom=13
++ get_col A1
++ local name=A1
++ for i in "${!cols[@]}"
++ [[ name == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ snp == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \A\1 ]]
++ echo 6
++ return
+ col_A1=6
++ get_col A2
++ local name=A2
++ for i in "${!cols[@]}"
++ [[ name == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ snp == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \A\2 ]]
++ echo 7
++ return
+ col_A2=7
++ get_col beta_hat
++ local name=beta_hat
++ for i in "${!cols[@]}"
++ [[ name == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ snp == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \b\e\t\a\_\h\a\t ]]
++ echo 8
++ return
+ col_beta_hat=8
++ get_col se
++ local name=se
++ for i in "${!cols[@]}"
++ [[ name == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \s\e ]]
++ echo 9
++ return
+ col_se=9
++ get_col p_value
++ local name=p_value
++ for i in "${!cols[@]}"
++ [[ name == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ pos == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \p\_\v\a\l\u\e ]]
++ echo 11
++ return
+ col_pval=11
++ get_col af
++ local name=af
++ for i in "${!cols[@]}"
++ [[ name == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ snp == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ se == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ pos == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ chrom == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ af == \a\f ]]
++ echo 14
++ return
+ col_af=14
++ get_col sample_size
++ local name=sample_size
++ for i in "${!cols[@]}"
++ [[ name == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pos == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \s\a\m\p\l\e\_\s\i\z\e ]]
++ echo 12
++ return
+ col_sample_size=12
++ get_col pub_sample_size
++ local name=pub_sample_size
++ for i in "${!cols[@]}"
++ [[ name == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ echo 3
++ return
+ col_pub_sample_size=3
++ get_col effect_is_or
++ local name=effect_is_or
++ for i in "${!cols[@]}"
++ [[ name == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ echo 4
++ return
+ col_effect_is_or=4
++ get_col name
++ local name=name
++ for i in "${!cols[@]}"
++ [[ name == \n\a\m\e ]]
++ echo 1
++ return
+ col_name=1
+ trait_files=()
+ (( i=2 ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=2 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
++ awk -F, -v row=2 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=2 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=2 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=2 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=2 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=2 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=2 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=2 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=2 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=2 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=2 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=2 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=2 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100001554
+ trait_out=workdir_1930361/C100001554.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz 1 0.05 RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_1930361/C100001554.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=0.05
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_1930361/C100001554.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.wRISwNx484
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554
+ parentdir=C100001554
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ fname=C100001554_regenie_rsid.tsv.gz
+ fname_noext=C100001554_regenie_rsid
+ harmon=C100001554_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=0.05 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.wRISwNx484
+ '[' false = true ']'
+ cp /tmp/tmp.wRISwNx484_af_filt /tmp/tmp.wRISwNx484_final
+ beta_hat=BETA
+ head /tmp/tmp.wRISwNx484_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0606195	1	9040	ADD	-0.00419287	0.0282127	0.0220867	0.054602	NA
rs3003377	1	10000458	1:10000458:T:C	T	C	0.782243	1	8971	ADD	0.00166499	0.0164153	0.0102879	0.0365854	NA
rs11166391	1	100004881	1:100004881:A:G	A	G	0.0675945	1	9017	ADD	-0.0549252	0.0269096	4.1661	1.38468	NA
rs564562	1	100006010	1:100006010:T:C	T	C	0.0604286	1	9052	ADD	-0.00849371	0.0282038	0.0906942	0.117307	NA
rs534252	1	100007048	1:100007048:A:G	A	G	0.109866	1	9061	ADD	-0.0231698	0.0215107	1.16021	0.550641	NA
rs113658116	1	100007750	1:100007750:G:A	G	A	0.0557472	1	8987	ADD	-0.0392142	0.0297855	1.73331	0.725868	NA
rs526128	1	100007871	1:100007871:T:A	T	A	0.108623	1	8953	ADD	-0.0293285	0.0217372	1.82043	0.751384	NA
rs3128113	1	1000079	1:1000079:A:G	A	G	0.776316	1	9082	ADD	0.024278	0.0163676	2.20015	0.860128	NA
rs522696	1	100011106	1:100011106:G:A	G	A	0.109534	1	9020	ADD	-0.0201029	0.0215978	0.86636	0.4535	NA
+ gwas_format /tmp/tmp.wRISwNx484_final workdir_1930361/C100001554.formatted.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.wRISwNx484_final
+ shift
+ local output=workdir_1930361/C100001554.formatted.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.8JPUvas9qY
+ parse_header /tmp/tmp.wRISwNx484_final
+ local file=/tmp/tmp.wRISwNx484_final
+ [[ ! -r /tmp/tmp.wRISwNx484_final ]]
+ [[ /tmp/tmp.wRISwNx484_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.wRISwNx484_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.wRISwNx484_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.wRISwNx484_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.8JPUvas9qY
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.8JPUvas9qY.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.8JPUvas9qY.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.8JPUvas9qY.nodup /tmp/tmp.8JPUvas9qY.pval
+ local infile=/tmp/tmp.8JPUvas9qY.nodup
+ local outfile=/tmp/tmp.8JPUvas9qY.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.8JPUvas9qY.nodup
+ cp /tmp/tmp.8JPUvas9qY.pval /tmp/tmp.8JPUvas9qY.nodup.step
+ flip_alleles /tmp/tmp.8JPUvas9qY.nodup.step workdir_1930361/C100001554.formatted.tsv 6 5 11 7
+ local infile=/tmp/tmp.8JPUvas9qY.nodup.step
+ local outfile=workdir_1930361/C100001554.formatted.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.8JPUvas9qY.nodup.step
+ echo 'Formatted GWAS file written to workdir_1930361/C100001554.formatted.tsv'
Formatted GWAS file written to workdir_1930361/C100001554.formatted.tsv
+ echo ' - formatted output written to workdir_1930361/C100001554.formatted.tsv'
 - formatted output written to workdir_1930361/C100001554.formatted.tsv
+ col_snp_x=snp
+ col_chrom_x=chrom
+ col_A1_x=A1
+ col_A2_x=A2
+ col_beta_hat_x=beta_hat
+ col_se_x=se
+ col_af_x=allele_freq
+ col_sample_size_x=sample_size
+ head -n 1 workdir_1930361/C100001554.formatted.tsv
snp	chrom	pos	ID	A2	A1	allele_freq	INFO	sample_size	TEST	beta_hat	se	CHISQ	p_value	EXTRA
+ echo workdir_1930361/C100001554.formatted.tsv
workdir_1930361/C100001554.formatted.tsv
+ echo workdir_1930361/C100001554.pub_ss.tsv
workdir_1930361/C100001554.pub_ss.tsv
+ echo 'Lines in trait_out BEFORE awk:'
Lines in trait_out BEFORE awk:
+ wc -l workdir_1930361/C100001554.formatted.tsv
406296 workdir_1930361/C100001554.formatted.tsv
+ awk -v pub_ss=6136 '
       BEGIN{FS=OFS="\t"; ss_col=-1}
       NR==1 {
           for(i=1;i<=NF;i++)
               if($i=="sample_size") ss_col=i;
           print
       }
       NR>1 {
           if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
           print
       }
   ' workdir_1930361/C100001554.formatted.tsv
+ [[ 0 != \N\A ]]
+ [[ 0 != '' ]]
+ [[ 0 != \0 ]]
+ cp workdir_1930361/C100001554.pub_ss.tsv workdir_1930361/C100001554.ss_tol.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom=chrom -v snp=snp -v A2=A2 -v A1=A1 -v beta=beta_hat -v se=se -v ss=sample_size -v af=allele_freq -v trait=C100001554 '
    BEGIN { OFS="\t" }
    NR==1 {
       # map column names to indices
        for(i=1; i<=NF; i++) {
            if($i==chrom) c_col=i;
            if($i==snp) s_col=i;
            if($i==A2) ref_col=i;
            if($i==A1) alt_col=i;
            if($i==beta) beta_col=i;
            if($i==se) se_col=i;
            if($i==ss) ss_col=i;
            if($i==af) af_col=i;
        }
       # header: rename columns
        print "chrom", "snp", "REF", "ALT", trait".beta", trait".se", trait".ss", trait".af", trait".z";
        next
    }
    {
        # assign variables
        beta = $beta_col;
        se   = $se_col;
        # check everything up front
        if (beta == "" || se == "" || beta == "NA" || se == "NA" || se == "0" || se == 0) {
            z = "NA";
        } else {
            z = beta / se;
        }
        print $c_col, $s_col, $ref_col, $alt_col, beta, se, $ss_col, $af_col, z;
    }
    ' workdir_1930361/C100001554.ss_tol.tsv
+ trait_files+=("$workdir/${trait_name}.cut.tsv")
+ (( i++ ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=3 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
++ awk -F, -v row=3 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=3 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=3 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=3 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=3 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=3 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=3 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=3 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=3 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=3 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=3 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=3 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=3 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100000010
+ trait_out=workdir_1930361/C100000010.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz 1 0.05 RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_1930361/C100000010.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=0.05
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_1930361/C100000010.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.Vu6fIvrKug
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010
+ parentdir=C100000010
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ fname=C100000010_regenie_rsid.tsv.gz
+ fname_noext=C100000010_regenie_rsid
+ harmon=C100000010_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=0.05 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.Vu6fIvrKug
+ '[' false = true ']'
+ cp /tmp/tmp.Vu6fIvrKug_af_filt /tmp/tmp.Vu6fIvrKug_final
+ beta_hat=BETA
+ head /tmp/tmp.Vu6fIvrKug_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0601692	1	8983	ADD	-0.00827698	0.030066	0.0757864	0.106188	NA
rs3003377	1	10000458	1:10000458:T:C	T	C	0.782092	1	8912	ADD	0.0270555	0.0174481	2.40445	0.917249	NA
rs11166391	1	100004881	1:100004881:A:G	A	G	0.0671133	1	8955	ADD	0.0522191	0.028753	3.29832	1.15895	NA
rs564562	1	100006010	1:100006010:T:C	T	C	0.0599422	1	8992	ADD	-0.00696232	0.0300682	0.0536158	0.0878381	NA
rs534252	1	100007048	1:100007048:A:G	A	G	0.109444	1	9000	ADD	0.0153129	0.0228866	0.447662	0.298046	NA
rs113658116	1	100007750	1:100007750:G:A	G	A	0.0561093	1	8929	ADD	-0.0304607	0.0315366	0.932932	0.476121	NA
rs526128	1	100007871	1:100007871:T:A	T	A	0.108163	1	8894	ADD	0.0185673	0.0231298	0.644393	0.37456	NA
rs3128113	1	1000079	1:1000079:A:G	A	G	0.776103	1	9022	ADD	0.0518769	0.0173921	8.89699	2.54418	NA
rs522696	1	100011106	1:100011106:G:A	G	A	0.109103	1	8964	ADD	0.0182073	0.0229882	0.627306	0.368206	NA
+ gwas_format /tmp/tmp.Vu6fIvrKug_final workdir_1930361/C100000010.formatted.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.Vu6fIvrKug_final
+ shift
+ local output=workdir_1930361/C100000010.formatted.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.wLUy4QiWtS
+ parse_header /tmp/tmp.Vu6fIvrKug_final
+ local file=/tmp/tmp.Vu6fIvrKug_final
+ [[ ! -r /tmp/tmp.Vu6fIvrKug_final ]]
+ [[ /tmp/tmp.Vu6fIvrKug_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.Vu6fIvrKug_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.Vu6fIvrKug_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.Vu6fIvrKug_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.wLUy4QiWtS
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.wLUy4QiWtS.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.wLUy4QiWtS.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.wLUy4QiWtS.nodup /tmp/tmp.wLUy4QiWtS.pval
+ local infile=/tmp/tmp.wLUy4QiWtS.nodup
+ local outfile=/tmp/tmp.wLUy4QiWtS.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.wLUy4QiWtS.nodup
+ cp /tmp/tmp.wLUy4QiWtS.pval /tmp/tmp.wLUy4QiWtS.nodup.step
+ flip_alleles /tmp/tmp.wLUy4QiWtS.nodup.step workdir_1930361/C100000010.formatted.tsv 6 5 11 7
+ local infile=/tmp/tmp.wLUy4QiWtS.nodup.step
+ local outfile=workdir_1930361/C100000010.formatted.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.wLUy4QiWtS.nodup.step
+ echo 'Formatted GWAS file written to workdir_1930361/C100000010.formatted.tsv'
Formatted GWAS file written to workdir_1930361/C100000010.formatted.tsv
+ echo ' - formatted output written to workdir_1930361/C100000010.formatted.tsv'
 - formatted output written to workdir_1930361/C100000010.formatted.tsv
+ col_snp_x=snp
+ col_chrom_x=chrom
+ col_A1_x=A1
+ col_A2_x=A2
+ col_beta_hat_x=beta_hat
+ col_se_x=se
+ col_af_x=allele_freq
+ col_sample_size_x=sample_size
+ head -n 1 workdir_1930361/C100000010.formatted.tsv
snp	chrom	pos	ID	A2	A1	allele_freq	INFO	sample_size	TEST	beta_hat	se	CHISQ	p_value	EXTRA
+ echo workdir_1930361/C100000010.formatted.tsv
workdir_1930361/C100000010.formatted.tsv
+ echo workdir_1930361/C100000010.pub_ss.tsv
workdir_1930361/C100000010.pub_ss.tsv
+ echo 'Lines in trait_out BEFORE awk:'
Lines in trait_out BEFORE awk:
+ wc -l workdir_1930361/C100000010.formatted.tsv
406333 workdir_1930361/C100000010.formatted.tsv
+ awk -v pub_ss=6136 '
       BEGIN{FS=OFS="\t"; ss_col=-1}
       NR==1 {
           for(i=1;i<=NF;i++)
               if($i=="sample_size") ss_col=i;
           print
       }
       NR>1 {
           if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
           print
       }
   ' workdir_1930361/C100000010.formatted.tsv
+ [[ 0 != \N\A ]]
+ [[ 0 != '' ]]
+ [[ 0 != \0 ]]
+ cp workdir_1930361/C100000010.pub_ss.tsv workdir_1930361/C100000010.ss_tol.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom=chrom -v snp=snp -v A2=A2 -v A1=A1 -v beta=beta_hat -v se=se -v ss=sample_size -v af=allele_freq -v trait=C100000010 '
    BEGIN { OFS="\t" }
    NR==1 {
       # map column names to indices
        for(i=1; i<=NF; i++) {
            if($i==chrom) c_col=i;
            if($i==snp) s_col=i;
            if($i==A2) ref_col=i;
            if($i==A1) alt_col=i;
            if($i==beta) beta_col=i;
            if($i==se) se_col=i;
            if($i==ss) ss_col=i;
            if($i==af) af_col=i;
        }
       # header: rename columns
        print "chrom", "snp", "REF", "ALT", trait".beta", trait".se", trait".ss", trait".af", trait".z";
        next
    }
    {
        # assign variables
        beta = $beta_col;
        se   = $se_col;
        # check everything up front
        if (beta == "" || se == "" || beta == "NA" || se == "NA" || se == "0" || se == 0) {
            z = "NA";
        } else {
            z = beta / se;
        }
        print $c_col, $s_col, $ref_col, $alt_col, beta, se, $ss_col, $af_col, z;
    }
    ' workdir_1930361/C100000010.ss_tol.tsv
+ trait_files+=("$workdir/${trait_name}.cut.tsv")
+ (( i++ ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=4 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
++ awk -F, -v row=4 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=4 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=4 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=4 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=4 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=4 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=4 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=4 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=4 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=4 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=4 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=4 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=4 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100000808
+ trait_out=workdir_1930361/C100000808.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz 1 0.05 RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_1930361/C100000808.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=0.05
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_1930361/C100000808.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.t8zWCtJOtF
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808
+ parentdir=C100000808
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ fname=C100000808_regenie_rsid.tsv.gz
+ fname_noext=C100000808_regenie_rsid
+ harmon=C100000808_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=0.05 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.t8zWCtJOtF
+ '[' false = true ']'
+ cp /tmp/tmp.t8zWCtJOtF_af_filt /tmp/tmp.t8zWCtJOtF_final
+ beta_hat=BETA
+ head /tmp/tmp.t8zWCtJOtF_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0601646	1	8992	ADD	-0.00333529	0.0297953	0.0125306	0.0405432	NA
rs3003377	1	10000458	1:10000458:T:C	T	C	0.78275	1	8916	ADD	0.0207176	0.0172887	1.43601	0.63679	NA
rs11166391	1	100004881	1:100004881:A:G	A	G	0.0667187	1	8963	ADD	-0.0343366	0.0285097	1.45054	0.641226	NA
rs564562	1	100006010	1:100006010:T:C	T	C	0.0599378	1	9001	ADD	-0.0071066	0.0297975	0.0568806	0.0907137	NA
rs534252	1	100007048	1:100007048:A:G	A	G	0.109014	1	9008	ADD	-0.023019	0.0227097	1.02743	0.507572	NA
rs113658116	1	100007750	1:100007750:G:A	G	A	0.0560962	1	8940	ADD	0.0582117	0.0312845	3.46228	1.20215	NA
rs526128	1	100007871	1:100007871:T:A	T	A	0.107817	1	8904	ADD	-0.0151042	0.0229435	0.433386	0.292147	NA
rs3128113	1	1000079	1:1000079:A:G	A	G	0.775938	1	9031	ADD	0.0158211	0.0172246	0.843668	0.445693	NA
rs522696	1	100011106	1:100011106:G:A	G	A	0.108684	1	8971	ADD	-0.0220008	0.022811	0.930221	0.475207	NA
+ gwas_format /tmp/tmp.t8zWCtJOtF_final workdir_1930361/C100000808.formatted.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.t8zWCtJOtF_final
+ shift
+ local output=workdir_1930361/C100000808.formatted.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.qT63QLebXH
+ parse_header /tmp/tmp.t8zWCtJOtF_final
+ local file=/tmp/tmp.t8zWCtJOtF_final
+ [[ ! -r /tmp/tmp.t8zWCtJOtF_final ]]
+ [[ /tmp/tmp.t8zWCtJOtF_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.t8zWCtJOtF_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.t8zWCtJOtF_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.t8zWCtJOtF_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.qT63QLebXH
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.qT63QLebXH.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.qT63QLebXH.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.qT63QLebXH.nodup /tmp/tmp.qT63QLebXH.pval
+ local infile=/tmp/tmp.qT63QLebXH.nodup
+ local outfile=/tmp/tmp.qT63QLebXH.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.qT63QLebXH.nodup
+ cp /tmp/tmp.qT63QLebXH.pval /tmp/tmp.qT63QLebXH.nodup.step
+ flip_alleles /tmp/tmp.qT63QLebXH.nodup.step workdir_1930361/C100000808.formatted.tsv 6 5 11 7
+ local infile=/tmp/tmp.qT63QLebXH.nodup.step
+ local outfile=workdir_1930361/C100000808.formatted.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.qT63QLebXH.nodup.step
+ echo 'Formatted GWAS file written to workdir_1930361/C100000808.formatted.tsv'
Formatted GWAS file written to workdir_1930361/C100000808.formatted.tsv
+ echo ' - formatted output written to workdir_1930361/C100000808.formatted.tsv'
 - formatted output written to workdir_1930361/C100000808.formatted.tsv
+ col_snp_x=snp
+ col_chrom_x=chrom
+ col_A1_x=A1
+ col_A2_x=A2
+ col_beta_hat_x=beta_hat
+ col_se_x=se
+ col_af_x=allele_freq
+ col_sample_size_x=sample_size
+ head -n 1 workdir_1930361/C100000808.formatted.tsv
snp	chrom	pos	ID	A2	A1	allele_freq	INFO	sample_size	TEST	beta_hat	se	CHISQ	p_value	EXTRA
+ echo workdir_1930361/C100000808.formatted.tsv
workdir_1930361/C100000808.formatted.tsv
+ echo workdir_1930361/C100000808.pub_ss.tsv
workdir_1930361/C100000808.pub_ss.tsv
+ echo 'Lines in trait_out BEFORE awk:'
Lines in trait_out BEFORE awk:
+ wc -l workdir_1930361/C100000808.formatted.tsv
406395 workdir_1930361/C100000808.formatted.tsv
+ awk -v pub_ss=6136 '
       BEGIN{FS=OFS="\t"; ss_col=-1}
       NR==1 {
           for(i=1;i<=NF;i++)
               if($i=="sample_size") ss_col=i;
           print
       }
       NR>1 {
           if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
           print
       }
   ' workdir_1930361/C100000808.formatted.tsv
+ [[ 0 != \N\A ]]
+ [[ 0 != '' ]]
+ [[ 0 != \0 ]]
+ cp workdir_1930361/C100000808.pub_ss.tsv workdir_1930361/C100000808.ss_tol.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom=chrom -v snp=snp -v A2=A2 -v A1=A1 -v beta=beta_hat -v se=se -v ss=sample_size -v af=allele_freq -v trait=C100000808 '
    BEGIN { OFS="\t" }
    NR==1 {
       # map column names to indices
        for(i=1; i<=NF; i++) {
            if($i==chrom) c_col=i;
            if($i==snp) s_col=i;
            if($i==A2) ref_col=i;
            if($i==A1) alt_col=i;
            if($i==beta) beta_col=i;
            if($i==se) se_col=i;
            if($i==ss) ss_col=i;
            if($i==af) af_col=i;
        }
       # header: rename columns
        print "chrom", "snp", "REF", "ALT", trait".beta", trait".se", trait".ss", trait".af", trait".z";
        next
    }
    {
        # assign variables
        beta = $beta_col;
        se   = $se_col;
        # check everything up front
        if (beta == "" || se == "" || beta == "NA" || se == "NA" || se == "0" || se == 0) {
            z = "NA";
        } else {
            z = beta / se;
        }
        print $c_col, $s_col, $ref_col, $alt_col, beta, se, $ss_col, $af_col, z;
    }
    ' workdir_1930361/C100000808.ss_tol.tsv
+ trait_files+=("$workdir/${trait_name}.cut.tsv")
+ (( i++ ))
+ (( i<=num_traits+1 ))
+ echo 'Full-joining all trait files: workdir_1930361/C100001554.cut.tsv' workdir_1930361/C100000010.cut.tsv workdir_1930361/C100000808.cut.tsv
Full-joining all trait files: workdir_1930361/C100001554.cut.tsv workdir_1930361/C100000010.cut.tsv workdir_1930361/C100000808.cut.tsv
+ csvtk join --outer-join --tabs -f chrom,snp,REF,ALT workdir_1930361/C100001554.cut.tsv workdir_1930361/C100000010.cut.tsv workdir_1930361/C100000808.cut.tsv
+ sed 's/\t\t/\tNA\t/g; s/\t$/\tNA/g' temp.tsv
