+ set -euo pipefail
+ chrom=1
+ gwas_info_file=/nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim
+ sample_size_tol=0.05
+ out=0
+ workdir=workdir_3734213
+ mkdir -p workdir_3734213
+ dos2unix /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
dos2unix: converting file /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv to Unix format...
++ wc -l
++ awk 'NR>1' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ num_traits=3
++ head -1 /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ header=name,raw_data_path,pub_sample_size,effect_is_or,snp,A1,A2,beta_hat,se,pos,p_value,sample_size,chrom,af
+ IFS=,
+ read -ra cols
++ get_col raw_data_path
++ local name=raw_data_path
++ for i in "${!cols[@]}"
++ [[ name == \r\a\w\_\d\a\t\a\_\p\a\t\h ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \r\a\w\_\d\a\t\a\_\p\a\t\h ]]
++ echo 2
++ return
+ col_raw_data=2
++ get_col snp
++ local name=snp
++ for i in "${!cols[@]}"
++ [[ name == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\n\p ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\n\p ]]
++ echo 5
++ return
+ col_snp=5
++ get_col pos
++ local name=pos
++ for i in "${!cols[@]}"
++ [[ name == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ snp == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ se == \p\o\s ]]
++ for i in "${!cols[@]}"
++ [[ pos == \p\o\s ]]
++ echo 10
++ return
+ col_pos=10
++ get_col chrom
++ local name=chrom
++ for i in "${!cols[@]}"
++ [[ name == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ snp == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ se == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ pos == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \c\h\r\o\m ]]
++ for i in "${!cols[@]}"
++ [[ chrom == \c\h\r\o\m ]]
++ echo 13
++ return
+ col_chrom=13
++ get_col A1
++ local name=A1
++ for i in "${!cols[@]}"
++ [[ name == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ snp == \A\1 ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \A\1 ]]
++ echo 6
++ return
+ col_A1=6
++ get_col A2
++ local name=A2
++ for i in "${!cols[@]}"
++ [[ name == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ snp == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \A\2 ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \A\2 ]]
++ echo 7
++ return
+ col_A2=7
++ get_col beta_hat
++ local name=beta_hat
++ for i in "${!cols[@]}"
++ [[ name == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ snp == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \b\e\t\a\_\h\a\t ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \b\e\t\a\_\h\a\t ]]
++ echo 8
++ return
+ col_beta_hat=8
++ get_col se
++ local name=se
++ for i in "${!cols[@]}"
++ [[ name == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \s\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \s\e ]]
++ echo 9
++ return
+ col_se=9
++ get_col p_value
++ local name=p_value
++ for i in "${!cols[@]}"
++ [[ name == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ pos == \p\_\v\a\l\u\e ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \p\_\v\a\l\u\e ]]
++ echo 11
++ return
+ col_pval=11
++ get_col af
++ local name=af
++ for i in "${!cols[@]}"
++ [[ name == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ snp == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ se == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ pos == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ chrom == \a\f ]]
++ for i in "${!cols[@]}"
++ [[ af == \a\f ]]
++ echo 14
++ return
+ col_af=14
++ get_col sample_size
++ local name=sample_size
++ for i in "${!cols[@]}"
++ [[ name == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ snp == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ A1 == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ A2 == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ beta_hat == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ se == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pos == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ p_value == \s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ sample_size == \s\a\m\p\l\e\_\s\i\z\e ]]
++ echo 12
++ return
+ col_sample_size=12
++ get_col pub_sample_size
++ local name=pub_sample_size
++ for i in "${!cols[@]}"
++ [[ name == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \p\u\b\_\s\a\m\p\l\e\_\s\i\z\e ]]
++ echo 3
++ return
+ col_pub_sample_size=3
++ get_col effect_is_or
++ local name=effect_is_or
++ for i in "${!cols[@]}"
++ [[ name == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ raw_data_path == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ pub_sample_size == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ for i in "${!cols[@]}"
++ [[ effect_is_or == \e\f\f\e\c\t\_\i\s\_\o\r ]]
++ echo 4
++ return
+ col_effect_is_or=4
++ get_col name
++ local name=name
++ for i in "${!cols[@]}"
++ [[ name == \n\a\m\e ]]
++ echo 1
++ return
+ col_name=1
+ trait_files=()
+ (( i=2 ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=2 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
++ awk -F, -v row=2 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=2 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=2 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=2 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=2 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=2 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=2 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=2 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=2 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=2 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=2 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=2 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=2 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100001554
+ trait_out=workdir_3734213/C100001554.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz 1 /nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_3734213/C100001554.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_3734213/C100001554.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.P4BXj3uFTd
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554
+ parentdir=C100001554
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ fname=C100001554_regenie_rsid.tsv.gz
+ fname_noext=C100001554_regenie_rsid
+ harmon=C100001554_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.P4BXj3uFTd
+ '[' false = true ']'
+ cp /tmp/tmp.P4BXj3uFTd_af_filt /tmp/tmp.P4BXj3uFTd_final
+ beta_hat=BETA
+ head /tmp/tmp.P4BXj3uFTd_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs118056241	1	100000223	1:100000223:C:T	C	T	0.0119863	1	9052	ADD	0.0662701	0.0621981	1.13522	0.542627	NA
rs112409036	1	10000044	1:10000044:A:T	A	T	0.0323685	1	9052	ADD	0.00583384	0.0380239	0.0235394	0.0564745	NA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0606195	1	9040	ADD	-0.00419287	0.0282127	0.0220867	0.054602	NA
rs116740877	1	100000839	1:100000839:T:A	T	A	0.00878453	1	9050	ADD	-0.00683072	0.0714076	0.00915049	0.0344258	NA
rs2149190	1	100001396	1:100001396:G:C	G	C	0.0495115	1	9008	ADD	-0.0440755	0.0310903	2.00976	0.806068	NA
rs78514868	1	100001756	1:100001756:T:C	T	C	0.00873894	1	9040	ADD	-0.00578546	0.0716216	0.0065251	0.0289012	NA
rs146254088	1	1000018	1:1000018:G:A	G	A	0.0207806	1	9095	ADD	-0.103554	0.0475189	4.74896	1.5329	NA
rs79671338	1	100002235	1:100002235:A:G	A	G	0.00877968	1	9055	ADD	-0.0125214	0.0714073	0.0307484	0.0650963	NA
rs12128170	1	100002416	1:100002416:C:T	C	T	0.0143379	1	9032	ADD	-0.0160104	0.0573385	0.0779666	0.107865	NA
+ gwas_format /tmp/tmp.P4BXj3uFTd_final out.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.P4BXj3uFTd_final
+ shift
+ local output=out.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.rR3KbMNIb4
+ parse_header /tmp/tmp.P4BXj3uFTd_final
+ local file=/tmp/tmp.P4BXj3uFTd_final
+ [[ ! -r /tmp/tmp.P4BXj3uFTd_final ]]
+ [[ /tmp/tmp.P4BXj3uFTd_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.P4BXj3uFTd_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.P4BXj3uFTd_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.P4BXj3uFTd_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.rR3KbMNIb4
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.rR3KbMNIb4.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.rR3KbMNIb4.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.rR3KbMNIb4.nodup /tmp/tmp.rR3KbMNIb4.pval
+ local infile=/tmp/tmp.rR3KbMNIb4.nodup
+ local outfile=/tmp/tmp.rR3KbMNIb4.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.rR3KbMNIb4.nodup
+ cp /tmp/tmp.rR3KbMNIb4.pval /tmp/tmp.rR3KbMNIb4.nodup.step
+ flip_alleles /tmp/tmp.rR3KbMNIb4.nodup.step out.tsv 6 5 11 7
+ local infile=/tmp/tmp.rR3KbMNIb4.nodup.step
+ local outfile=out.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.rR3KbMNIb4.nodup.step
+ rm -f /tmp/tmp.rR3KbMNIb4 /tmp/tmp.rR3KbMNIb4.legal /tmp/tmp.rR3KbMNIb4.unambig /tmp/tmp.rR3KbMNIb4.nodup /tmp/tmp.rR3KbMNIb4.pval /tmp/tmp.rR3KbMNIb4.nodup.step
+ echo 'Formatted GWAS file written to out.tsv'
Formatted GWAS file written to out.tsv
+ echo ' - formatted output written to out.tsv'
 - formatted output written to out.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom_old=13 -v snp_old=5 -v ref_old=7 -v alt_old=6 -v se_old=9 -v ss_old=12 -v af_old=14 -v trait=C100001554 '
    NR==1 {
      for (i=1; i<=NF; i++) {
        if ($i == chrom_old)      $i = "chrom";
        else if ($i == snp_old)   $i = "snp";
        else if ($i == ref_old)   $i = "REF";
        else if ($i == alt_old)   $i = "ALT";
        else if ($i == se_old)    $i = trait ".se";
        else if ($i == ss_old)    $i = trait ".ss";
        else if ($i == af_old)    $i = trait ".af";
        else if ($i == "Z")       $i = trait ".z";
      }
      print; next;
    }
    { print }
    '
+ awk '-F\t' -v 'OFS=\t' '
    NR==1 {
      # find column indices
      for(i=1;i<=NF;i++){
        if($i=="8") beta_col=i;
        if($i=="9") se_col=i;
      }
      print $0, "Z";
      next
    }
    {
      # compute Z, handle missing
      z = ($beta_col=="" || $se_col=="" || $se_col==0 || $beta_col=="NA" || $se_col=="NA") ? "NA" : $beta_col/$se_col;
      print $0, z;
    }
    '
+ csvtk cut -t -f 13,5,7,6,8,9,12,14 /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100001554/C100001554_regenie_rsid.tsv.gz
+ head -n 1 workdir_3734213/C100001554.formatted.tsv
CHISQ	ALLELE0	A1FREQ	ALLELE1	INFO	N	SE	LOG10P	C100001554.z
+ awk -v pub_ss=6136 '
        BEGIN{FS=OFS="\t"; ss_col=-1}
        NR==1 {
	    for(i=1;i<=NF;i++)
	        if($i=="sample_size") ss_col=i;
            print
        }
        NR>1 {
            if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
            print
        }
    ' workdir_3734213/C100001554.formatted.tsv
awk: cmd. line:9: (FILENAME=workdir_3734213/C100001554.formatted.tsv FNR=2) fatal: attempt to access field -1
+ [[ 0.05 != \N\A ]]
+ [[ 0.05 != '' ]]
+ [[ 0.05 != \0 ]]
++ awk 'NR>1 && $NF!="NA"{a[NR]=$NF} END{n=asort(a); m=int(n/2); print a[m]}' workdir_3734213/C100001554.formatted.tsv
+ median=1
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1-tol)*m}'
+ lower=0.95
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1+tol)*m}'
+ upper=1.05
+ awk -v lower=0.95 -v upper=1.05 '
            NR==1 {print}
            NR>1 {if($NF >= lower && $NF <= upper) print}
        ' workdir_3734213/C100001554.formatted.tsv
+ mv workdir_3734213/C100001554.formatted.tsv.trimmed workdir_3734213/C100001554.formatted.tsv
+ trait_files+=("$trait_out")
+ (( i++ ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=3 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
++ awk -F, -v row=3 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=3 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=3 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=3 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=3 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=3 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=3 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=3 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=3 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=3 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=3 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=3 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=3 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100000010
+ trait_out=workdir_3734213/C100000010.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz 1 /nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_3734213/C100000010.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_3734213/C100000010.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.9VqRZAWn1u
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010
+ parentdir=C100000010
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ fname=C100000010_regenie_rsid.tsv.gz
+ fname_noext=C100000010_regenie_rsid
+ harmon=C100000010_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.9VqRZAWn1u
+ '[' false = true ']'
+ cp /tmp/tmp.9VqRZAWn1u_af_filt /tmp/tmp.9VqRZAWn1u_final
+ beta_hat=BETA
+ head /tmp/tmp.9VqRZAWn1u_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs118056241	1	100000223	1:100000223:C:T	C	T	0.0123402	1	8995	ADD	0.0292121	0.0651138	0.20127	0.184623	NA
rs112409036	1	10000044	1:10000044:A:T	A	T	0.0321397	1	8992	ADD	0.020784	0.0405718	0.262426	0.215769	NA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0601692	1	8983	ADD	-0.00827698	0.030066	0.0757864	0.106188	NA
rs116740877	1	100000839	1:100000839:T:A	T	A	0.00850851	1	8991	ADD	0.0404857	0.0769673	0.276688	0.22266	NA
rs2149190	1	100001396	1:100001396:G:C	G	C	0.0495531	1	8950	ADD	0.0384418	0.0331106	1.34795	0.609705	NA
rs78514868	1	100001756	1:100001756:T:C	T	C	0.00846325	1	8980	ADD	0.0409637	0.0772069	0.281504	0.22496	NA
rs146254088	1	1000018	1:1000018:G:A	G	A	0.0206397	1	9036	ADD	0.0185783	0.0506179	0.134711	0.146547	NA
rs79671338	1	100002235	1:100002235:A:G	A	G	0.00850189	1	8998	ADD	0.0306215	0.0769668	0.158288	0.160687	NA
rs12128170	1	100002416	1:100002416:C:T	C	T	0.01409	1	8978	ADD	-0.0878517	0.0613856	2.04818	0.817048	NA
+ gwas_format /tmp/tmp.9VqRZAWn1u_final out.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.9VqRZAWn1u_final
+ shift
+ local output=out.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.bKMx2msrtP
+ parse_header /tmp/tmp.9VqRZAWn1u_final
+ local file=/tmp/tmp.9VqRZAWn1u_final
+ [[ ! -r /tmp/tmp.9VqRZAWn1u_final ]]
+ [[ /tmp/tmp.9VqRZAWn1u_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.9VqRZAWn1u_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.9VqRZAWn1u_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.9VqRZAWn1u_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.bKMx2msrtP
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.bKMx2msrtP.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.bKMx2msrtP.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.bKMx2msrtP.nodup /tmp/tmp.bKMx2msrtP.pval
+ local infile=/tmp/tmp.bKMx2msrtP.nodup
+ local outfile=/tmp/tmp.bKMx2msrtP.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.bKMx2msrtP.nodup
+ cp /tmp/tmp.bKMx2msrtP.pval /tmp/tmp.bKMx2msrtP.nodup.step
+ flip_alleles /tmp/tmp.bKMx2msrtP.nodup.step out.tsv 6 5 11 7
+ local infile=/tmp/tmp.bKMx2msrtP.nodup.step
+ local outfile=out.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.bKMx2msrtP.nodup.step
+ rm -f /tmp/tmp.bKMx2msrtP /tmp/tmp.bKMx2msrtP.legal /tmp/tmp.bKMx2msrtP.unambig /tmp/tmp.bKMx2msrtP.nodup /tmp/tmp.bKMx2msrtP.pval /tmp/tmp.bKMx2msrtP.nodup.step
+ echo 'Formatted GWAS file written to out.tsv'
Formatted GWAS file written to out.tsv
+ echo ' - formatted output written to out.tsv'
 - formatted output written to out.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom_old=13 -v snp_old=5 -v ref_old=7 -v alt_old=6 -v se_old=9 -v ss_old=12 -v af_old=14 -v trait=C100000010 '
    NR==1 {
      for (i=1; i<=NF; i++) {
        if ($i == chrom_old)      $i = "chrom";
        else if ($i == snp_old)   $i = "snp";
        else if ($i == ref_old)   $i = "REF";
        else if ($i == alt_old)   $i = "ALT";
        else if ($i == se_old)    $i = trait ".se";
        else if ($i == ss_old)    $i = trait ".ss";
        else if ($i == af_old)    $i = trait ".af";
        else if ($i == "Z")       $i = trait ".z";
      }
      print; next;
    }
    { print }
    '
+ awk '-F\t' -v 'OFS=\t' '
    NR==1 {
      # find column indices
      for(i=1;i<=NF;i++){
        if($i=="8") beta_col=i;
        if($i=="9") se_col=i;
      }
      print $0, "Z";
      next
    }
    {
      # compute Z, handle missing
      z = ($beta_col=="" || $se_col=="" || $se_col==0 || $beta_col=="NA" || $se_col=="NA") ? "NA" : $beta_col/$se_col;
      print $0, z;
    }
    '
+ csvtk cut -t -f 13,5,7,6,8,9,12,14 /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000010/C100000010_regenie_rsid.tsv.gz
+ head -n 1 workdir_3734213/C100000010.formatted.tsv
CHISQ	ALLELE0	A1FREQ	ALLELE1	INFO	N	SE	LOG10P	C100000010.z
+ awk -v pub_ss=6136 '
        BEGIN{FS=OFS="\t"; ss_col=-1}
        NR==1 {
	    for(i=1;i<=NF;i++)
	        if($i=="sample_size") ss_col=i;
            print
        }
        NR>1 {
            if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
            print
        }
    ' workdir_3734213/C100000010.formatted.tsv
awk: cmd. line:9: (FILENAME=workdir_3734213/C100000010.formatted.tsv FNR=2) fatal: attempt to access field -1
+ [[ 0.05 != \N\A ]]
+ [[ 0.05 != '' ]]
+ [[ 0.05 != \0 ]]
++ awk 'NR>1 && $NF!="NA"{a[NR]=$NF} END{n=asort(a); m=int(n/2); print a[m]}' workdir_3734213/C100000010.formatted.tsv
+ median=1
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1-tol)*m}'
+ lower=0.95
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1+tol)*m}'
+ upper=1.05
+ awk -v lower=0.95 -v upper=1.05 '
            NR==1 {print}
            NR>1 {if($NF >= lower && $NF <= upper) print}
        ' workdir_3734213/C100000010.formatted.tsv
+ mv workdir_3734213/C100000010.formatted.tsv.trimmed workdir_3734213/C100000010.formatted.tsv
+ trait_files+=("$trait_out")
+ (( i++ ))
+ (( i<=num_traits+1 ))
++ awk -F, -v row=4 -v col=2 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ f=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
++ awk -F, -v row=4 -v col=5 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ snp=RSID
++ awk -F, -v row=4 -v col=10 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pos=GENPOS
++ awk -F, -v row=4 -v col=13 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ chrn=CHROM
++ awk -F, -v row=4 -v col=6 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A1=ALLELE1
++ awk -F, -v row=4 -v col=7 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ A2=ALLELE0
++ awk -F, -v row=4 -v col=8 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ beta_hat=BETA
++ awk -F, -v row=4 -v col=9 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ se=SE
++ awk -F, -v row=4 -v col=11 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pval=LOG10P
++ awk -F, -v row=4 -v col=14 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ af=A1FREQ
++ awk -F, -v row=4 -v col=12 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ sample_size=N
++ awk -F, -v row=4 -v col=4 'NR==row {print tolower($col)}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ effect_or=false
++ awk -F, -v row=4 -v col=3 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ pub_sample_size=6136
++ awk -F, -v row=4 -v col=1 'NR==row {print $col}' /nfs/turbo/sph-jvmorr/GFA_metabolites_2025/C100001554_And_Friends_3Metabolites.csv
+ trait_name=C100000808
+ trait_out=workdir_3734213/C100000808.formatted.tsv
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.vcf.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.vcf.bgz ]]
+ bash format_flat_chrom.sh /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz 1 /nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim RSID GENPOS CHROM ALLELE1 ALLELE0 BETA SE LOG10P A1FREQ N false workdir_3734213/C100000808.formatted.tsv
in format_flat_chrom.sh:
+ source get_col.sh
++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ source gwas_format.sh
++ set -x
++ source get_col.sh
+++ [[ get_col.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
++ [[ gwas_format.sh == \f\o\r\m\a\t\_\f\l\a\t\_\c\h\r\o\m\.\s\h ]]
+ echo ' - loaded modules'
 - loaded modules
+ set -euo pipefail
+ trap 'echo "script failed with exit code $? at line $LINENO" >&2' ERR
+ echo ' - set pipefail'
 - set pipefail
+ file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ chrom=1
+ af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim
+ snp_name=RSID
+ pos_name=GENPOS
+ chrom_name=CHROM
+ A1_name=ALLELE1
+ A2_name=ALLELE0
+ beta_hat_name=BETA
+ se_name=SE
+ p_value_name=LOG10P
+ af_name=A1FREQ
+ sample_size_name=N
+ effect_is_or=false
+ output=workdir_3734213/C100000808.formatted.tsv
+ echo ' - read function inputs'
 - read function inputs
+ parse_header /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ local file=/nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ [[ ! -r /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz ]]
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.gz ]]
++ awk 'NR==1 {print; exit}' /dev/fd/63
+++ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ echo RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ snp_col_ind=1
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ pos_col_ind=3
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ chrom_col_ind=2
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ A1_col_ind=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ A2_col_ind=5
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ beta_col_ind=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ se_col_ind=12
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ p_col_ind=14
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ af_col_ind=7
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ ss_col_ind=9
+ echo ' - parsed gwas file header'
 - parsed gwas file header
+ echo 'Mem used after step 1: parsing gwas file header'
+ awk '/VmRSS/{print}' /proc/self/status
++ mktemp
+ file_filt=/tmp/tmp.nUygSbzHyg
+ [[ /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz == *.gz ]]
+ awk '-F\t' -v snp_col=1 '
            NR==1 {print; next}
            {count[$snp_col]++; lines[NR]=$0; keys[NR]=$snp_col}
            END {for (i=2; i<=NR; i++) if (count[keys[i]]==1) print lines[i]}
      '
+ awk '-F\t' -v col=2 -v chrom=1 'NR==1 || $col == chrom'
+ gzip -cd /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ echo 'Mem used after step 2b: read and filter gwas file'
+ awk '/VmRSS/{print}' /proc/self/status
+++ dirname /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808
+ parentdir=C100000808
++ basename /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ fname=C100000808_regenie_rsid.tsv.gz
+ fname_noext=C100000808_regenie_rsid
+ harmon=C100000808_regenie_rsid_chrom1_harmon_snps.tsv
+ awk '-F\t' -v af_col=7 -v af_thresh=/nfs/turbo/sph-jvmorr/ld_reference_files/1kg_plink_hg38/EUR_autosomal.bim 'NR==1 {print; next} ($af_col > af_thresh && $af_col < (1 - af_thresh)) {print}' /tmp/tmp.nUygSbzHyg
+ '[' false = true ']'
+ cp /tmp/tmp.nUygSbzHyg_af_filt /tmp/tmp.nUygSbzHyg_final
+ beta_hat=BETA
+ head /tmp/tmp.nUygSbzHyg_final
RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA
rs118056241	1	100000223	1:100000223:C:T	C	T	0.0120515	1	9003	ADD	-0.109169	0.0652691	2.79759	1.025	NA
rs112409036	1	10000044	1:10000044:A:T	A	T	0.0323261	1	9002	ADD	-0.0247991	0.0400986	0.382483	0.270611	NA
rs11166389	1	100000723	1:100000723:G:A	G	A	0.0601646	1	8992	ADD	-0.00333529	0.0297953	0.0125306	0.0405432	NA
rs116740877	1	100000839	1:100000839:T:A	T	A	0.0086657	1	9001	ADD	0.122783	0.0756097	2.63706	0.981313	NA
rs2149190	1	100001396	1:100001396:G:C	G	C	0.0492242	1	8959	ADD	-0.0343468	0.0328642	1.09226	0.528751	NA
rs78514868	1	100001756	1:100001756:T:C	T	C	0.00861877	1	8992	ADD	0.124415	0.0758405	2.69119	0.996089	NA
rs146254088	1	1000018	1:1000018:G:A	G	A	0.0208955	1	9045	ADD	-0.0433976	0.0498677	0.757343	0.415486	NA
rs79671338	1	100002235	1:100002235:A:G	A	G	0.00866185	1	9005	ADD	0.127073	0.0756094	2.82458	1.0323	NA
rs12128170	1	100002416	1:100002416:C:T	C	T	0.0138039	1	8983	ADD	0.016933	0.0614517	0.0759282	0.106297	NA
+ gwas_format /tmp/tmp.nUygSbzHyg_final out.tsv RSID BETA SE ALLELE1 ALLELE0 CHROM GENPOS LOG10P N A1FREQ TRUE
+ local input=/tmp/tmp.nUygSbzHyg_final
+ shift
+ local output=out.tsv
+ shift
+ local SNP_COL=RSID
+ shift
+ local BETA_COL=BETA
+ shift
+ local SE_COL=SE
+ shift
+ local A1_COL=ALLELE1
+ shift
+ local A2_COL=ALLELE0
+ shift
+ local CHROM_COL=CHROM
+ shift
+ local POS_COL=GENPOS
+ shift
+ local PVALUE_COL=LOG10P
+ shift
+ local SAMPLESIZE_COL=N
+ shift
+ local AF_COL=A1FREQ
+ shift
+ local compute_pval=TRUE
+ shift
++ mktemp
+ TMP=/tmp/tmp.F1SjKHZdd5
+ parse_header /tmp/tmp.nUygSbzHyg_final
+ local file=/tmp/tmp.nUygSbzHyg_final
+ [[ ! -r /tmp/tmp.nUygSbzHyg_final ]]
+ [[ /tmp/tmp.nUygSbzHyg_final == *.gz ]]
++ awk 'NR==1 {print; exit}' /tmp/tmp.nUygSbzHyg_final
+ header='RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA'
+ [[ -z RSID	CHROM	GENPOS	ID	ALLELE0	ALLELE1	A1FREQ	INFO	N	TEST	BETA	SE	CHISQ	LOG10P	EXTRA ]]
+ IFS='	'
+ read -r -a cols
+ declare -gA col_indices
+ for i in "${!cols[@]}"
+ colname=RSID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo RSID
+ colname=RSID
+ col_indices[$colname]=1
+ for i in "${!cols[@]}"
+ colname=CHROM
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHROM
+ colname=CHROM
+ col_indices[$colname]=2
+ for i in "${!cols[@]}"
+ colname=GENPOS
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo GENPOS
+ colname=GENPOS
+ col_indices[$colname]=3
+ for i in "${!cols[@]}"
+ colname=ID
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ID
+ colname=ID
+ col_indices[$colname]=4
+ for i in "${!cols[@]}"
+ colname=ALLELE0
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE0
+ colname=ALLELE0
+ col_indices[$colname]=5
+ for i in "${!cols[@]}"
+ colname=ALLELE1
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo ALLELE1
+ colname=ALLELE1
+ col_indices[$colname]=6
+ for i in "${!cols[@]}"
+ colname=A1FREQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo A1FREQ
+ colname=A1FREQ
+ col_indices[$colname]=7
+ for i in "${!cols[@]}"
+ colname=INFO
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo INFO
+ colname=INFO
+ col_indices[$colname]=8
+ for i in "${!cols[@]}"
+ colname=N
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo N
+ colname=N
+ col_indices[$colname]=9
+ for i in "${!cols[@]}"
+ colname=TEST
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo TEST
+ colname=TEST
+ col_indices[$colname]=10
+ for i in "${!cols[@]}"
+ colname=BETA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo BETA
+ colname=BETA
+ col_indices[$colname]=11
+ for i in "${!cols[@]}"
+ colname=SE
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo SE
+ colname=SE
+ col_indices[$colname]=12
+ for i in "${!cols[@]}"
+ colname=CHISQ
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo CHISQ
+ colname=CHISQ
+ col_indices[$colname]=13
+ for i in "${!cols[@]}"
+ colname=LOG10P
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo LOG10P
+ colname=LOG10P
+ col_indices[$colname]=14
+ for i in "${!cols[@]}"
+ colname=EXTRA
++ sed 's/^[`"'\'' ]*//;s/[`"'\'' ]*$//'
++ echo EXTRA
+ colname=EXTRA
+ col_indices[$colname]=15
+ return 0
++ get_col RSID
++ local name=RSID
++ [[ RSID != '' ]]
++ [[ RSID != \N\A ]]
++ [[ -v col_indices[RSID] ]]
++ echo 1
+ local snp_col=1
++ get_col BETA
++ local name=BETA
++ [[ BETA != '' ]]
++ [[ BETA != \N\A ]]
++ [[ -v col_indices[BETA] ]]
++ echo 11
+ local beta_col=11
++ get_col SE
++ local name=SE
++ [[ SE != '' ]]
++ [[ SE != \N\A ]]
++ [[ -v col_indices[SE] ]]
++ echo 12
+ local se_col=12
++ get_col ALLELE1
++ local name=ALLELE1
++ [[ ALLELE1 != '' ]]
++ [[ ALLELE1 != \N\A ]]
++ [[ -v col_indices[ALLELE1] ]]
++ echo 6
+ local a1_col=6
++ get_col ALLELE0
++ local name=ALLELE0
++ [[ ALLELE0 != '' ]]
++ [[ ALLELE0 != \N\A ]]
++ [[ -v col_indices[ALLELE0] ]]
++ echo 5
+ local a2_col=5
++ get_col CHROM
++ local name=CHROM
++ [[ CHROM != '' ]]
++ [[ CHROM != \N\A ]]
++ [[ -v col_indices[CHROM] ]]
++ echo 2
+ local chrom_col=2
++ get_col GENPOS
++ local name=GENPOS
++ [[ GENPOS != '' ]]
++ [[ GENPOS != \N\A ]]
++ [[ -v col_indices[GENPOS] ]]
++ echo 3
+ local pos_col=3
++ get_col LOG10P
++ local name=LOG10P
++ [[ LOG10P != '' ]]
++ [[ LOG10P != \N\A ]]
++ [[ -v col_indices[LOG10P] ]]
++ echo 14
+ local p_col=14
++ get_col N
++ local name=N
++ [[ N != '' ]]
++ [[ N != \N\A ]]
++ [[ -v col_indices[N] ]]
++ echo 9
+ local ss_col=9
++ get_col A1FREQ
++ local name=A1FREQ
++ [[ A1FREQ != '' ]]
++ [[ A1FREQ != \N\A ]]
++ [[ -v col_indices[A1FREQ] ]]
++ echo 7
+ local af_col=7
+ csvtk -t headers /tmp/tmp.nUygSbzHyg_final
RSID
CHROM
GENPOS
ID
ALLELE0
ALLELE1
A1FREQ
INFO
N
TEST
BETA
SE
CHISQ
LOG10P
EXTRA
+ awk -v snp_col=1 -v beta_col=11 -v se_col=12 -v a1_col=6 -v a2_col=5 -v chrom_col=2 -v pos_col=3 -v p_col=14 -v ss_col=9 -v af_col=7 'NR==1{
      $snp_col="snp";
      $beta_col="beta_hat";
      $se_col="se";
      $a1_col="A1";
      $a2_col="A2";
      $chrom_col="chrom";
      $pos_col="pos";
      $p_col="p_value";
      $ss_col="sample_size";
      $af_col="allele_freq";
      print; next
    }
    {
      $a1_col = toupper($a1_col);
      $a2_col = toupper($a2_col);
      print;
    }' 'OFS=\t' /tmp/tmp.nUygSbzHyg_final
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    ($a1_col=="A" || $a1_col=="C" || $a1_col=="G" || $a1_col=="T") &&
    ($a2_col=="A" || $a2_col=="C" || $a2_col=="G" || $a2_col=="T")
    ' /tmp/tmp.F1SjKHZdd5
+ awk '-F\t' -v a1_col=6 -v a2_col=5 '
    NR==1 {print; next}
    !( (($a1_col=="A" && $a2_col=="T") || ($a1_col=="T" && $a2_col=="A")) ||
       (($a1_col=="G" && $a2_col=="C") || ($a1_col=="C" && $a2_col=="G")) )
    {print}
    ' /tmp/tmp.F1SjKHZdd5.legal
+ awk '-F\t' -v snp_col=1 'NR==1 {print; next} !a[$snp_col]++' /tmp/tmp.F1SjKHZdd5.unambig
+ [[ TRUE == \T\R\U\E ]]
+ compute_pvalue /tmp/tmp.F1SjKHZdd5.nodup /tmp/tmp.F1SjKHZdd5.pval
+ local infile=/tmp/tmp.F1SjKHZdd5.nodup
+ local outfile=/tmp/tmp.F1SjKHZdd5.pval
+ awk '-F\t' '
    BEGIN{OFS="\t"} NR==1 {for(i=1;i<=NF;i++) idx[$i]=i; print; next}
    {
        # If p_value is missing and beta/se are present
        if ($idx["p_value"] == "" || $idx["p_value"] == "NA") {
            b = $idx["beta_hat"]
            s = $idx["se"]

            # Check if se is blank, NA, or 0
            if (s == "" || s == "NA" || s == 0) {
                $idx["p_value"] = "NA"
            } else {
                z = b / s
                p = 2 * (1 - systat(z))
                $idx["p_value"] = p
            }
        }
        print
    }
    function systat(z){return 0.5*erfc(-z/sqrt(2));}
    function erfc(x){return 1 - erf(x)}
    function erf(x){
      a1=0.254829592; a2=-0.284496736; a3=1.421413741; a4=-1.453152027; a5=1.061405429; p=0.3275911;
      sign=1; if(x<0) sign=-1; x=abs(x); t=1.0/(1.0+p*x);
      y=1.0-((((a5*t+a4)*t+a3)*t+a2)*t+a1)*t*exp(-x*x)
      return sign*y
    }
    ' /tmp/tmp.F1SjKHZdd5.nodup
+ cp /tmp/tmp.F1SjKHZdd5.pval /tmp/tmp.F1SjKHZdd5.nodup.step
+ flip_alleles /tmp/tmp.F1SjKHZdd5.nodup.step out.tsv 6 5 11 7
+ local infile=/tmp/tmp.F1SjKHZdd5.nodup.step
+ local outfile=out.tsv
+ local a1_col=6
+ local a2_col=5
+ local beta_col=11
+ local af_col=7
+ awk '-F\t' -v a1_col=6 -v a2_col=5 -v beta_col=11 -v af_col=7 -v 'OFS=\t' '
    function flip_allele(x) {
      return (x == "A") ? "T" : (x == "T") ? "A" : (x == "G") ? "C" : (x == "C") ? "G" : x
    }
    NR==1 {print $0; next}
    {
      A1 = $a1_col; A2 = $a2_col
      if (A1 == "T" || A2 == "T") {
        A1f = flip_allele(A1); A2f = flip_allele(A2)
      } else {
        A1f = A1; A2f = A2
      }
      if (A1f == "A") {
        eA1 = A1f; eA2 = A2f; new_beta = $beta_col
        if (af_col) new_af = ($af_col != "") ? $af_col : ""
      } else {
        eA1 = A2f; eA2 = A1f; new_beta = -$beta_col
        if (af_col) new_af = ($af_col != "") ? 1-$af_col : ""
      }
      for (i=1; i<=NF; i++) {
        if (i == a1_col) printf "%s", eA1
        else if (i == a2_col) printf "%s", eA2
        else if (i == beta_col) printf "%s", new_beta
        else if (af_col && i == af_col) printf "%s", new_af
        else printf "%s", $i
        printf (i == NF ? "\n" : OFS)
      }
    }
    ' /tmp/tmp.F1SjKHZdd5.nodup.step
+ rm -f /tmp/tmp.F1SjKHZdd5 /tmp/tmp.F1SjKHZdd5.legal /tmp/tmp.F1SjKHZdd5.unambig /tmp/tmp.F1SjKHZdd5.nodup /tmp/tmp.F1SjKHZdd5.pval /tmp/tmp.F1SjKHZdd5.nodup.step
+ echo 'Formatted GWAS file written to out.tsv'
Formatted GWAS file written to out.tsv
+ echo ' - formatted output written to out.tsv'
 - formatted output written to out.tsv
+ awk '-F\t' -v 'OFS=\t' -v chrom_old=13 -v snp_old=5 -v ref_old=7 -v alt_old=6 -v se_old=9 -v ss_old=12 -v af_old=14 -v trait=C100000808 '
    NR==1 {
      for (i=1; i<=NF; i++) {
        if ($i == chrom_old)      $i = "chrom";
        else if ($i == snp_old)   $i = "snp";
        else if ($i == ref_old)   $i = "REF";
        else if ($i == alt_old)   $i = "ALT";
        else if ($i == se_old)    $i = trait ".se";
        else if ($i == ss_old)    $i = trait ".ss";
        else if ($i == af_old)    $i = trait ".af";
        else if ($i == "Z")       $i = trait ".z";
      }
      print; next;
    }
    { print }
    '
+ awk '-F\t' -v 'OFS=\t' '
    NR==1 {
      # find column indices
      for(i=1;i<=NF;i++){
        if($i=="8") beta_col=i;
        if($i=="9") se_col=i;
      }
      print $0, "Z";
      next
    }
    {
      # compute Z, handle missing
      z = ($beta_col=="" || $se_col=="" || $se_col==0 || $beta_col=="NA" || $se_col=="NA") ? "NA" : $beta_col/$se_col;
      print $0, z;
    }
    '
+ csvtk cut -t -f 13,5,7,6,8,9,12,14 /nfs/turbo/sph-jvmorr/gwas_summary_statistics/METSIM/with_rsid/C100000808/C100000808_regenie_rsid.tsv.gz
+ head -n 1 workdir_3734213/C100000808.formatted.tsv
CHISQ	ALLELE0	A1FREQ	ALLELE1	INFO	N	SE	LOG10P	C100000808.z
+ awk -v pub_ss=6136 '
        BEGIN{FS=OFS="\t"; ss_col=-1}
        NR==1 {
	    for(i=1;i<=NF;i++)
	        if($i=="sample_size") ss_col=i;
            print
        }
        NR>1 {
            if($ss_col == "" || $ss_col == "NA") $ss_col=pub_ss;
            print
        }
    ' workdir_3734213/C100000808.formatted.tsv
awk: cmd. line:9: (FILENAME=workdir_3734213/C100000808.formatted.tsv FNR=2) fatal: attempt to access field -1
+ [[ 0.05 != \N\A ]]
+ [[ 0.05 != '' ]]
+ [[ 0.05 != \0 ]]
++ awk 'NR>1 && $NF!="NA"{a[NR]=$NF} END{n=asort(a); m=int(n/2); print a[m]}' workdir_3734213/C100000808.formatted.tsv
+ median=1
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1-tol)*m}'
+ lower=0.95
++ awk -v m=1 -v tol=0.05 'BEGIN{print (1+tol)*m}'
+ upper=1.05
+ awk -v lower=0.95 -v upper=1.05 '
            NR==1 {print}
            NR>1 {if($NF >= lower && $NF <= upper) print}
        ' workdir_3734213/C100000808.formatted.tsv
+ mv workdir_3734213/C100000808.formatted.tsv.trimmed workdir_3734213/C100000808.formatted.tsv
+ trait_files+=("$trait_out")
+ (( i++ ))
+ (( i<=num_traits+1 ))
+ echo 'Full-joining all trait files: workdir_3734213/C100001554.formatted.tsv' workdir_3734213/C100000010.formatted.tsv workdir_3734213/C100000808.formatted.tsv
Full-joining all trait files: workdir_3734213/C100001554.formatted.tsv workdir_3734213/C100000010.formatted.tsv workdir_3734213/C100000808.formatted.tsv
+ csvtk join --outer-join --tabs -f chrom,snp,REF,ALT workdir_3734213/C100001554.formatted.tsv workdir_3734213/C100000010.formatted.tsv workdir_3734213/C100000808.formatted.tsv
[31m[ERRO][0m column "chrom" not existed in file: workdir_3734213/C100001554.formatted.tsv
